<script>
new Vue({
    el: '#app',
    data: {
        cart: [],
        order: {
            firstName: '',
            lastName: '',
            address: '',
            city: '',
            zip: '',
            gift: false,
            method: '',
            lessons: []  
        },
        cities: {
            DXB: 'Dubai',
            ADB: 'Abu Dhabi',
            SHJ: 'Sharjah',
            AJM: 'Ajman',
            UAQ: 'Umm Al Quwain',
            RAK: 'Ras Al Khaimah',
            FUJ: 'Fujairah'
        },
        validationErrors: {
            firstName: '',
            lastName: '',
            address: '',
            zip: '',
            city: '',
            method: ''
        }
    },
    computed: {
        completedForm() {
            return this.order.firstName &&
                this.order.lastName &&
                this.order.address &&
                this.order.city &&
                this.order.zip &&
                this.order.method &&
                Object.values(this.validationErrors).every(error => error === '');
        },
        cartTotal() {
            return this.cart.reduce((total, item) => total + (item.price * item.quantity), 0);
        }
    },
    methods: {
        validateFirstName() {
            if (!this.order.firstName) {
                this.validationErrors.firstName = "First name is required.";
            } else if (/\d/.test(this.order.firstName)) {
                this.validationErrors.firstName = "First name cannot contain numbers.";
            } else {
                this.validationErrors.firstName = '';
            }
        },

        validateLastName() {
            if (!this.order.lastName) {
                this.validationErrors.lastName = "Last name is required.";
            } else if (/\d/.test(this.order.lastName)) {
                this.validationErrors.lastName = "Last name cannot contain numbers.";
            } else {
                this.validationErrors.lastName = '';
            }
        },

        validateAddress() {
            if (!this.order.address) {
                this.validationErrors.address = "Address is required.";
            } else if (/^\d+$/.test(this.order.address)) {
                this.validationErrors.address = "Address cannot contain only numbers.";
            } else {
                this.validationErrors.address = '';
            }
        },

        validateZip() {
            if (!this.order.zip) {
                this.validationErrors.zip = "Postal code is required.";
            } else if (!/^\d{5,6}$/.test(this.order.zip)) {
                this.validationErrors.zip = "Postal code must be a valid number with 5 or 6 digits.";
            } else {
                this.validationErrors.zip = '';
            }
        },

        validateCity() {
            if (!this.order.city) {
                this.validationErrors.city = "Please select a city.";
            } else {
                this.validationErrors.city = '';
            }
        },

        validateMethod() {
            if (!this.order.method) {
                this.validationErrors.method = "Please select a delivery method.";
            } else {
                this.validationErrors.method = '';
            }
        },

        saveDetails(key) {
            this.validateFirstName();
            this.validateLastName();
            this.validateAddress();
            this.validateZip();
            this.validateCity();
            this.validateMethod();

            localStorage.setItem('order', JSON.stringify(this.order));
        },

        submitForm() {
            // Trigger validation on submit
            this.validateFirstName();
            this.validateLastName();
            this.validateAddress();
            this.validateZip();
            this.validateCity();
            this.validateMethod();

            // If no errors, proceed with submission
            if (this.completedForm) {
                const orderData = {
                    firstName: this.order.firstName,
                    lastName: this.order.lastName,
                    address: this.order.address,
                    city: this.order.city,
                    zip: this.order.zip,
                    gift: this.order.gift,
                    method: this.order.method,
                    lessons: this.order.lessons,
                };

                fetch('https://backend-mdx.onrender.com/collections/Orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData),
                })
                .then(response => response.json())
                .then(data => {
                    alert('Order placed successfully!');
                    this.clearCart();
                    this.clearDetails();
                })
                .catch(error => {
                    console.error('Error placing order:', error);
                    alert('There was an error placing your order. Please try again.');
                });
            } else {
                alert("Please fix the errors in the form.");
            }
        },

        clearCart() {
            this.cart = [];
            localStorage.removeItem('cart');
        },

        clearDetails() {
            this.order.firstName = '';
            this.order.lastName = '';
            this.order.address = '';
            this.order.city = '';
            this.order.zip = '';
            this.order.gift = false;
            this.order.method = '';
            localStorage.removeItem('order');
        },

        loadCart() {
            const cartData = JSON.parse(localStorage.getItem('cart')) || [];
            this.cart = cartData;
            this.order.lessons = cartData.map(item => ({
                lessonTitle: item.title,
                price: item.price,
                quantity: item.quantity,
            }));
        },

        loadDetails() {
            const orderData = JSON.parse(localStorage.getItem('order')) || {};
            Object.assign(this.order, orderData);
        },

        mounted() {
            this.loadCart();
            this.loadDetails();
        }
    }
});
</script>
